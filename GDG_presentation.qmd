---
title: "Catching <img src='https://cdn3.emoji.gg/emojis/3565-200w.gif' width='80px' height='100px' alt='200w'>: Scaling Shiny Apps with Google's Firebase"
author: "Umair Durrani"
execute: 
  eval: false
  echo: true
highlight-style: github
format: 
  revealjs:
    #incremental: true
    #footer: "`emitanaka.org/slides/toronto2022`"
    slide-number: true
    multiplex: true
    theme: [simple, assets/monash.scss]
    show-slide-number: all
    controls: true
    width: 1280
    height: 720
    css: [assets/syntax-highlight.css, assets/custom.css, assets/pacman.css]
---

## What is shiny?

::: info-box

An R package that lets you create web applications with no knowledge* of HTML / CSS / Javascript  

:::

. . . 

  \  
  

**Web applications?** Software that you access and use in a web browser  
  
  \  
  \  
    
. . . 

\* mostly


## What about python?

![](shiny_r_python.png)

# Let's take a look at an example app

##

```{=html}
<iframe width="800" height="800" src="https://umair.shinyapps.io/GoogleDevelopersGroupShiny/_w_f3eb35a9/?" title="Shiny app"></iframe>
```



# Getting Started {background-color="#b22626"}


## Structure of a shiny app

```{r}
library(shiny)

ui <- fluidPage(
  
)

server <- function(input, output, session) {
  
}

shinyApp(ui, server)
```




## Create Project

![](firebase_create_project.PNG)

## Give your project a name


![](firebase_create_project_step1.PNG)

## Enable Google Analytics (Optional)

![](firebase_create_project_step2.PNG)


## {background-image="firebase_project_created.PNG"}


# Create an app

## Select web app

![](firebase_create_app.PNG)

## Give your app a name

![](firebase_create_app_1.PNG)

## {background-image="firebase_create_app_2.PNG" background-size="800px"}

<!--![](firebase_create_app_2.PNG)-->

## Now you can add authentication to your app

![](firebase_app_created.PNG)


# Authentication

## {background-image="firebase_authentication1.PNG" background-size="1200px"}


## Choose sign-in methods

![](firebase_authentication2.PNG)


## Gmail {background-image="firebase_authentication3.PNG"}

<!-- ![](firebase_authentication3.PNG) -->


## You may also enable sign-in via email

![](firebase_authentication4.PNG)


## Add users manually 

![](firebase_authentication5.PNG)





# Build the app using {shiny}

## Authentication

```{r}
#| code-line-numbers: "5-10"
polished::polished_config(
    app_name = "APP_NAME",
    api_key = "POLISHED_API_KEY",

    firebase_config = list(
      apiKey = "FIREBASE_API_KEY",
      authDomain = "AUTH_DOMAIN",
      projectId = "PROJECT_ID"
    ),
    sign_in_providers = c("google", "email")
  )
```


## Programmatically add users and sign in

Define a function:  
```{r}
#| code-line-numbers: "1|2-3|4|5-10|13"
sign.in <- function(email, password, api_key) {
  r <- httr::POST(paste0("https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=", api_key),
    httr::add_headers("Content-Type" = "application/json"),
    body = jsonlite::toJSON(
      list(
        email = email,
        password = password,
        returnSecureToken = TRUE
      ),
      auto_unbox = TRUE
    )
  )
  return(httr::content(r))
}
```

. . .   

Use the function:
```{r}
user <- sign.in("user_email",  "user_password", api_key)
accessToken <- user$idToken
email <- user$email
```


## Sign out

:::: {.columns}

::: {.column width="50%"}
User Interface (UI):

```{r}
actionButton(inputId = "sign_out", label = "Sign Out")
```

:::
  
::: {.column width="50%"}
Server:

```{r}
  observeEvent(input$sign_out, {
    polished::sign_out_from_shiny()
    session$reload()
  })
```

:::
  
::::

![](shiny_sign_out.png){width=50%}



## Getting `inputs` from user

:::: {.columns}

::: {.column width="60%"}
UI:

```{r}
tagList(
# sex
  radioGroupButtons(
    inputId = "sex",
    label = "Are you a girl or a boy?",
    choices = list("Girl" = 1L, "Boy" = 0L),
    status = "primary",
    selected = character(0)
  ),
  
  # age
  sliderInput(
    inputId = "age",
    label = "What is your age?",
    min = 12,
    max = 18,
    value = 15,
    step = 1
  ),
  
  # career
  radioGroupButtons(
    inputId = "career",
    label = "I am a career tribute.",
    choices = list("Yes" = 1L, "No" = 0L),
    status = "primary",
    selected = character(0)
  ),
  
  # rating
  sliderInput(
    inputId = "rating",
    label = "How would you rate your survival skills?",
    min = 3,
    max = 11,
    value = 5,
    step = 1
  )
)
```


:::
  
::: {.column width="40%"}
![](shiny_form.png)
:::
  
::::


## Getting `inputs` from user

:::: {.columns}

::: {.column width="50%"}
UI:

```{r}
#| code-line-numbers: "4|13|23|32"
tagList(
  # sex
  radioGroupButtons(
    inputId = "sex",
    label = "Are you a girl or a boy?",
    choices = list("Girl" = 1L, "Boy" = 0L),
    status = "primary",
    selected = character(0)
  ),
  
  # age
  sliderInput(
    inputId = "age",
    label = "What is your age?",
    min = 12,
    max = 18,
    value = 15,
    step = 1
  ),
  
  # career
  radioGroupButtons(
    inputId = "career",
    label = "I am a career tribute.",
    choices = list("Yes" = 1L, "No" = 0L),
    status = "primary",
    selected = character(0)
  ),
  
  # rating
  sliderInput(
    inputId = "rating",
    label = "How would you rate your survival skills?",
    min = 3,
    max = 11,
    value = 5,
    step = 1
  )
)
```


:::
  
::: {.column width="50%"}
Server:

```{r}
#| code-line-numbers: "4|5|6|7"
# Form inputs in one list
form_inputs <- reactive({
  list(
   sex    = input$sex,
   age    = input$age,
   career = input$career,
   rating = input$rating
  )
})

# Send data to firestore when 'Submit' is clicked
observeEvent(
      input$form_submit,
      {
      ## Convert data to json structure
        form_data_list <- toJSON(list(
          fields = list(
            uid = list("stringValue" = email()),
            Sex = list("integerValue" = form_inputs()[["sex"]]),
            Age = list("integerValue" = form_inputs()[["age"]]),
            Career = list("integerValue" = form_inputs()[["career"]]),
            Rating = list("integerValue" = form_inputs()[["rating"]])
          )
        ), auto_unbox = TRUE)


        ## writing data
        endpoint_quiz <- "projects/gdg-demo-b8928/databases/(default)/documents/Quiz"
        
        
        write.db <- function(db_endpoint, data, auth_token) {
  r <- httr::POST(sprintf("https://firestore.googleapis.com/v1beta1/%s", db_endpoint),
    httr::add_headers(
      "Content-Type" = "application/json",
      "Authorization" = paste("Bearer", auth_token)
    ),
    body = data
  )
  return(r)
}
        
        write_request_quiz <- write.db(
          db_endpoint = paste0(endpoint_quiz, "?documentId=", email()),
          data = form_data_list,
          auth_token = accessToken()
        )
    }
)
```

:::
  
::::




